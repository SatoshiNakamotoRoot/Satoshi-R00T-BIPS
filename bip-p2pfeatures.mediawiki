<pre>
  BIP: p2pfeatures
  Layer: Peer Services
  Title: Pre-verack Feature Negotiation
  Author: Anthony Towns <aj@erisian.com.au>
  Status: Draft
  Type: Standards Track
  Created: 2022-10-07
  License: BSD-3-Clause
</pre>

==Abstract==

This document specifies a P2P protocol extension for negotiation of new P2P protocol features between two peers.

==Motivation==

* reduces reliance on limited number of service flags
* avoids potential for two proposals to both use the same version number to indicate support
* allows features to become unsupported

==Specification==

The protocol version of nodes implementing this BIP must be set to 70017 or higher.

After receiving a version message specifying a version of 70017 or higher, nodes implementing this BIP:

* must ignore unknown messages received prior to receiving a verack
* may send feature negotiation messages prior to sending verack

After receiving a version message specifying a version lower than 70017, nodes implementing this BIP:

* must not send feature negotiation messages

Feature negotiation should be complete once verack has been received, so nodes should not receive unexpected messages after receiving a verack message, and may choose to close the connection if they do.

===Intended Protocol Flow===

It is intended that future BIPs that introduce new P2P features will be designed as follows:

* A new feature negotiation message will be introduced.
* Peers that implement the BIP must send that message to peers that advertise a version of 70017 or higher.
* The feature will be enabled if, and only if, both peers sent the feature negotiation message.

This allows new features to be introduced in parallel, including adding or changing post-verack protocol messages, without needing to bump the protocol version.

If the feature requires additional parameters beyond simply indicating that it is supported, the feature negotiation message may include a data payload with those parameters.

Where possible, feature negotiation should simply involve announcing the features you support -- the feature negotiation messages you send should not be conditional on the feature negotiation messages you receive from your peer, only the initial version message.

==Backward compatibility==

Older clients remain fully compatible and interoperable after this change.

==See Also==

This mechanism standardises the technique used by [https://github.com/bitcoin/bips/blob/master/bip-0130.mediawiki BIP-130 (sendheaders)], [https://github.com/bitcoin/bips/blob/master/bip-0152.mediawiki BIP-152 (sendcmpct)], [https://github.com/bitcoin/bips/blob/master/bip-0155.mediawiki BIP-155 (sendaddrv2)], [https://github.com/bitcoin/bips/blob/master/bip-0339.mediawiki BIP-339 (wtxidrelay)].

Prior draft from Suhas Daftuar: [https://github.com/sdaftuar/bips/blob/2020-08-generalized-feature-negotiation/bip-p2p-feature-negotiation.mediawiki bip-p2p-feature-negotiation] and [https://lists.linuxfoundation.org/pipermail/bitcoin-dev/2020-August/018084.html bitcoin-dev discussion].

==Acknowledgments==

==Copyright==

This document is licensed under the Creative Commons CC0 1.0 Universal license.
